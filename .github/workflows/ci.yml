name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  contents: write

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build

      - name: Run tests with coverage
        run: npm test
        continue-on-error: true

      - name: Coverage Summary
        if: success() || always()
        run: |
          echo "## Coverage Report" >> $GITHUB_STEP_SUMMARY
          echo '| Metric | Percentage |' >> $GITHUB_STEP_SUMMARY
          echo '|--------|------------|' >> $GITHUB_STEP_SUMMARY
          if [ -f coverage/coverage-final.json ]; then
            node -e "
              const fs = require('fs');
              const coverage = JSON.parse(fs.readFileSync('coverage/coverage-final.json', 'utf8'));

              // Calculate totals from v8 coverage format
              let totalLines = 0;
              let coveredLines = 0;
              let totalBranches = 0;
              let coveredBranches = 0;
              let totalFunctions = 0;
              let coveredFunctions = 0;

              Object.values(coverage).forEach(file => {
                if (file.s) {
                  Object.values(file.s).forEach(v => {
                    totalLines++;
                    if (v > 0) coveredLines++;
                  });
                }
                if (file.b) {
                  Object.values(file.b).forEach(branches => {
                    totalBranches += branches.length;
                    coveredBranches += branches.filter(v => v > 0).length;
                  });
                }
                if (file.f) {
                  Object.values(file.f).forEach(v => {
                    totalFunctions++;
                    if (v > 0) coveredFunctions++;
                  });
                }
              });

              const linesPct = totalLines > 0 ? (coveredLines / totalLines) * 100 : 0;
              const branchesPct = totalBranches > 0 ? (coveredBranches / totalBranches) * 100 : 0;
              const functionsPct = totalFunctions > 0 ? (coveredFunctions / totalFunctions) * 100 : 0;

              console.log('| Statements | ' + linesPct.toFixed(2) + '% |');
              console.log('| Branches | ' + branchesPct.toFixed(2) + '% |');
              console.log('| Functions | ' + functionsPct.toFixed(2) + '% |');
              console.log('| Lines | ' + linesPct.toFixed(2) + '% |');
            " >> $GITHUB_STEP_SUMMARY 2>/dev/null || echo "Coverage generated" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Generate coverage badge
        if: success() && hashFiles('coverage/coverage-final.json') != ''
        run: |
          node -e "
            const fs = require('fs');
            const coverage = JSON.parse(fs.readFileSync('coverage/coverage-final.json', 'utf8'));

            // Calculate totals from v8 coverage format
            let totalLines = 0;
            let coveredLines = 0;
            let totalBranches = 0;
            let coveredBranches = 0;
            let totalFunctions = 0;
            let coveredFunctions = 0;

            Object.values(coverage).forEach(file => {
              if (file.s) {
                Object.values(file.s).forEach(v => {
                  totalLines++;
                  if (v > 0) coveredLines++;
                });
              }
              if (file.b) {
                Object.values(file.b).forEach(branches => {
                  totalBranches += branches.length;
                  coveredBranches += branches.filter(v => v > 0).length;
                });
              }
              if (file.f) {
                Object.values(file.f).forEach(v => {
                  totalFunctions++;
                  if (v > 0) coveredFunctions++;
                });
              }
            });

            const linesPct = totalLines > 0 ? (coveredLines / totalLines) * 100 : 0;
            const branchesPct = totalBranches > 0 ? (coveredBranches / totalBranches) * 100 : 0;
            const functionsPct = totalFunctions > 0 ? (coveredFunctions / totalFunctions) * 100 : 0;

            const pct = linesPct;
            const color = pct >= 90 ? 'brightgreen' : pct >= 80 ? 'green' : pct >= 70 ? 'yellowgreen' : pct >= 60 ? 'yellow' : pct >= 50 ? 'orange' : 'red';
            const badge = {
              schemaVersion: 1,
              label: 'Coverage',
              message: pct.toFixed(2) + '%',
              color: color,
            };
            fs.writeFileSync('coverage/badge.json', JSON.stringify(badge, null, 2));
            console.log('Coverage:', pct.toFixed(2) + '%');
          "

      - name: Upload coverage to GitHub
        if: always() && hashFiles('coverage/**') != ''
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage/
          retention-days: 30

      - name: Upload coverage badge
        if: success() && hashFiles('coverage/badge.json') != ''
        uses: actions/upload-artifact@v4
        with:
          name: coverage-badge
          path: coverage/badge.json
          retention-days: 90

      - name: Deploy coverage badge to gh-pages
        if: success() && hashFiles('coverage/badge.json') != '' && github.ref == 'refs/heads/main'
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./coverage
          publish_branch: gh-pages
          keep_files: false
